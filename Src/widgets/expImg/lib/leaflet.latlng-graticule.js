/* 2018-7-27 19:23:44 | 版权所有 火星科技 http://marsgis.cn  【联系我们QQ：516584683，微信：marsgis】 */
document,L.LatLngGraticule=L.Layer.extend({includes:L.Mixin.Events,options:{showLabel:!0,opacity:1,weight:.8,color:"#aaa",font:"12px Verdana",lngLineCurved:0,latLineCurved:0,zoomInterval:[{start:2,end:2,interval:40},{start:3,end:3,interval:20},{start:4,end:4,interval:10},{start:5,end:7,interval:5},{start:8,end:20,interval:1}]},initialize:function(t){L.setOptions(this,t),this.options.font.split(" ").length<2&&(this.options.font+=" Verdana"),this.options.fontColor||(this.options.fontColor=this.options.color),this.options.zoomInterval&&(this.options.zoomInterval.latitude&&(this.options.latInterval=this.options.zoomInterval.latitude,this.options.zoomInterval.longitude||(this.options.lngInterval=this.options.zoomInterval.latitude)),this.options.zoomInterval.longitude&&(this.options.lngInterval=this.options.zoomInterval.longitude,this.options.zoomInterval.latitude||(this.options.latInterval=this.options.zoomInterval.longitude)),this.options.latInterval||(this.options.latInterval=this.options.zoomInterval),this.options.lngInterval||(this.options.lngInterval=this.options.zoomInterval))},onAdd:function(t){this._map=t,this._container||this._initCanvas(),t._panes.overlayPane.appendChild(this._container),t.on("viewreset",this._reset,this),t.on("move",this._reset,this),t.on("moveend",this._reset,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){if(this._container)try{t._panes.overlayPane.removeChild(this._container)}catch(t){}t.off("viewreset",this._reset,this),t.off("move",this._reset,this),t.off("moveend",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},setOpacity:function(t){return this.options.opacity=t,this._updateOpacity(),this},bringToFront:function(){return this._canvas&&this._map._panes.overlayPane.appendChild(this._canvas),this},bringToBack:function(){var t=this._map._panes.overlayPane;return this._canvas&&t.insertBefore(this._canvas,t.firstChild),this},getAttribution:function(){return this.options.attribution},_initCanvas:function(){this._container=L.DomUtil.create("div","leaflet-image-layer"),this._canvas=L.DomUtil.create("canvas",""),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._canvas,"leaflet-zoom-animated"):L.DomUtil.addClass(this._canvas,"leaflet-zoom-hide"),this._updateOpacity(),this._container.appendChild(this._canvas),L.extend(this._canvas,{onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onCanvasLoad,this)})},_animateZoom:function(t){var n=this._map,i=(this._container,this._canvas),o=n.getZoomScale(t.zoom),a=n.containerPointToLatLng([0,0]),e=n.containerPointToLatLng([i.width,i.height]),s=n._latLngToNewLayerPoint(a,t.zoom,t.center),r=n._latLngToNewLayerPoint(e,t.zoom,t.center)._subtract(s);s._add(r._multiplyBy(.5*(1-1/o)))},_reset:function(){var t=this._container,n=this._canvas,i=this._map.getSize(),o=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(t,o),t.style.width=i.x+"px",t.style.height=i.y+"px",n.width=i.x,n.height=i.y,n.style.width=i.x+"px",n.style.height=i.y+"px",this.__calcInterval()},_onCanvasLoad:function(){this.fire("load")},_updateOpacity:function(){L.DomUtil.setOpacity(this._canvas,this.options.opacity)},__format_lat:function(t){return this.options.latFormatTickLabel?this.options.latFormatTickLabel(t):t<0?-1*t+"S":0<t?t+"N":""+t},__format_lng:function(t){return this.options.lngFormatTickLabel?this.options.lngFormatTickLabel(t):180<t?360-t+"W":0<t&&t<180?t+"E":t<0&&-180<t?-1*t+"W":-180==t?""+-1*t:t<-180?360+t+"W":""+t},__calcInterval:function(){var t=this._map.getZoom();if(this._currZoom!=t&&(this._currLngInterval=0,this._currLatInterval=0,this._currZoom=t),!this._currLngInterval)try{for(var n in this.options.lngInterval)if((i=this.options.lngInterval[n]).start<=t&&i.end&&i.end>=t){this._currLngInterval=i.interval;break}}catch(t){this._currLngInterval=0}if(!this._currLatInterval)try{for(var n in this.options.latInterval){var i;if((i=this.options.latInterval[n]).start<=t&&i.end&&i.end>=t){this._currLatInterval=i.interval;break}}}catch(t){this._currLatInterval=0}},__draw:function(v){var t=this._canvas,c=this._map,p=this.options.lngLineCurved,_=this.options.latLineCurved;if(L.Browser.canvas&&c){this._currLngInterval&&this._currLatInterval||this.__calcInterval();var n=this._currLatInterval,i=this._currLngInterval,g=t.getContext("2d");g.clearRect(0,0,t.width,t.height),g.lineWidth=this.options.weight,g.strokeStyle=this.options.color,g.fillStyle=this.options.fontColor,this.options.font&&(g.font=this.options.font);var f=g.measureText("0").width,m=12;try{var o=g.font.split(" ")[0];m=function(t){2<t.length&&"p"==t.charAt(t.length-2)&&(t=t.substr(0,t.length-2));try{return parseInt(t,10)}catch(t){}return 0}(o)}catch(t){}var u=t.width,l=t.height,a=c.containerPointToLatLng(L.point(0,0)),e=c.containerPointToLatLng(L.point(u,0)),h=c.containerPointToLatLng(L.point(u,l)).lat,d=a.lat,y=a.lng,x=e.lng,s=(d-h)/(.2*l);if(isNaN(s))return;s<1&&(s=1),h=h<-90?-90:parseInt(h-s,10),d=90<d?90:parseInt(d+s,10);var T=(x-y)/(.2*u);T<1&&(T=1),0<y&&x<0&&(x+=360),x=parseInt(x+T,10),y=parseInt(y-T,10);var I,P,C,b=.5;function r(t,n){if(I=t._latLngToCanvasPoint(L.latLng(n,y)),P=t.__format_lat(n),f=g.measureText(P).width,_){"number"==typeof _&&(b=_);var i=y,o=x;0<I.x&&(i=(i=c.containerPointToLatLng(L.point(0,I.y))).lng-T,I.x=0),(l=t._latLngToCanvasPoint(L.latLng(n,o))).x<u&&(o=(o=c.containerPointToLatLng(L.point(u,l.y))).lng+T,0<i&&o<0&&(o+=360)),g.beginPath(),g.moveTo(I.x,I.y);for(var a=null,e=i;e<=o;e+=b){if(l=t._latLngToCanvasPoint(L.latLng(n,e)),g.lineTo(l.x,l.y),t.options.showLabel&&v&&null!=a)if(a.x<0&&0<=l.x){var s=(l.x-0)/(l.x-a.x),r=l.y-(l.y-a.y)*s;g.fillText(P,0,r+m/2)}else a.x<=u-f&&l.x>u-f&&(s=(l.x-u)/(l.x-a.x),r=l.y-(l.y-a.y)*s,g.fillText(P,u-f,r+m/2-2));a={x:l.x,y:l.y,lon:e,lat:w}}g.stroke()}else{o=x;var l=t._latLngToCanvasPoint(L.latLng(n,o));if(p&&(o=(o=c.containerPointToLatLng(L.point(0,l.y))).lng,l=t._latLngToCanvasPoint(L.latLng(n,o)),i=(i=c.containerPointToLatLng(L.point(u,l.y))).lng,I=t._latLngToCanvasPoint(L.latLng(n,i))),g.beginPath(),g.moveTo(I.x+1,I.y),g.lineTo(l.x-1,l.y),g.stroke(),t.options.showLabel&&v){var h=I.y+m/2-2;g.fillText(P,0,h),g.fillText(P,u-f,h)}}}if(0<n){for(var w=n;w<=d;w+=n)h<=w&&r(this,w);for(w=0;h<=w;w-=n)w<=d&&r(this,w)}function z(t,n){C=t.__format_lng(n),f=g.measureText(C).width;var i=t._latLngToCanvasPoint(L.latLng(h,n));if(p){"number"==typeof p&&(_lat_delta=p),g.beginPath(),g.moveTo(i.x,i.y);for(var o=null,a=h;a<d;a+=_lat_delta){var e=t._latLngToCanvasPoint(L.latLng(a,n));g.lineTo(e.x,e.y),t.options.showLabel&&v&&null!=o&&(8<o.y&&e.y<=8?g.fillText(C,e.x-f/2,m):o.y>=l&&e.y<l&&g.fillText(C,e.x-f/2,l-2)),o={x:e.x,y:e.y,lon:n,lat:a}}g.stroke()}else{var s=d;if(e=t._latLngToCanvasPoint(L.latLng(s,n)),_){90<(s=(s=c.containerPointToLatLng(L.point(e.x,0))).lat)&&(s=90),e=t._latLngToCanvasPoint(L.latLng(s,n));var r=c.containerPointToLatLng(L.point(i.x,l));(r=r.lat)<-90&&(r=-90),i=t._latLngToCanvasPoint(L.latLng(r,n))}g.beginPath(),g.moveTo(e.x,e.y+1),g.lineTo(i.x,i.y-1),g.stroke(),t.options.showLabel&&v&&(g.fillText(C,e.x-f/2,m+1),g.fillText(C,i.x-f/2,l-3))}}if(0<i){for(w=i;w<=x;w+=i)y<=w&&z(this,w);for(w=0;y<=w;w-=i)w<=x&&z(this,w)}}},_latLngToCanvasPoint:function(t){map=this._map;var n=map.project(L.latLng(t));return n._subtract(map.getPixelOrigin()),L.point(n).add(map._getMapPanePos())}}),L.latlngGraticule=function(t){return new L.LatLngGraticule(t)};