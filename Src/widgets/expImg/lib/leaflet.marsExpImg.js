/* 2018-9-21 19:22:13 | 版权所有 火星科技 http://marsgis.cn  【联系我们QQ：516584683，微信：marsgis】 */
L.ExpImgCrl=L.Class.extend({options:{title:"地图导出图片",position:"topleft",printModes:["Portrait","Landscape","Custom"],printModesNames:{Portrait:"外框",Auto:"全屏",Cancel:"取消",Custom:"出图"},latlngControl:{}},initialize:function(t){L.setOptions(this,t)},init:function(t){this.$mapParentDiv=$("#"+this.options.eleid),this._map=t,this._isContainerRemove=!0},onAdd:function(){this.$mapParentDiv=$("#"+this.options.eleid);var t=L.DomUtil.create("div","leaflet-control-browser-print leaflet-bar leaflet-control");L.DomEvent.disableClickPropagation(t);var o=L.DomUtil.create("a","",t);this.link=o,this.link.id="leaflet-browser-print",this.link.title=this.options.title,L.DomEvent.addListener(t,"mouseover",this._displayPageSizeButtons,this),L.DomEvent.addListener(t,"mouseout",this._hidePageSizeButtons,this),this.holder=L.DomUtil.create("ul","browser-print-holder",t);for(var i=[],e=0;e<this.options.printModes.length;e++){var n=this.options.printModes[e],s=n[0].toUpperCase()+n.substring(1).toLowerCase();if(this["_print"+s]){if("Portrait"==s){var a=this._form=L.DomUtil.create("form","leaflet-control-position-form",this.holder);a.style.display="none";var r=this._input_lon=document.createElement("input");r.className="leaflet-control-position-form-input-lon",r.name="lon",r.type="number",r.placeholder="经度网格数",r.style.width="70px",r.style.height="30px";var l=this._input_lat=document.createElement("input");l.className="leaflet-control-position-form-input-lat",l.type="number",l.name="lat",l.placeholder="纬度网格数",l.style.width="70px",l.style.height="30px",this._placeholder(l,"#999"),this._placeholder(r,"#999"),(h=L.DomUtil.create("li","browser-print-mode")).innerHTML=this.options.printModesNames?this.options.printModesNames[s]:s,a.appendChild(l),a.appendChild(r),a.appendChild(h),L.DomEvent.addListener(h,"click",this["_print"+s],this)}else{var h;(h=L.DomUtil.create("li","browser-print-mode",this.holder)).innerHTML=this.options.printModesNames?this.options.printModesNames[s]:s,L.DomEvent.addListener(h,"click",this["_print"+s],this)}i.push(h)}}return this.options.printModes=i,setTimeout(function(){t.className+=parseInt(L.version)?" v1":" v0-7"},10),this._isContainerRemove=!0,t},_placeholder:function(t,o){if(!("placeholder"in document.createElement("input"))){var i=t,e=i.placeholder;i.onfocus=function(){i.value==e&&(i.value="",i.style.color="")},i.onblur=function(){""==i.value&&(i.value=e,i.style.color=o)},i.value=e,i.style.color=o}},_displayPageSizeButtons:function(){this.holder.style.marginTop="-"+this.link.clientHeight-1+"px",0<this.options.position.indexOf("left")?(this.link.style.borderTopRightRadius="0px",this.link.style.borderBottomRightRadius="0px",this.holder.style.marginLeft=this.link.clientWidth+"px"):(this.link.style.borderTopLeftRadius="0px",this.link.style.borderBottomLeftRadius="0px",this.holder.style.marginRight=this.link.clientWidth+"px"),this.options.printModes.forEach(function(t){t.style.display="inline-block"}),this._form.style.display="inline-block"},_hidePageSizeButtons:function(){this.holder.style.marginTop="",0<this.options.position.indexOf("left")?(this.link.style.borderTopRightRadius="",this.link.style.borderBottomRightRadius="",this.holder.style.marginLeft=""):(this.link.style.borderTopLeftRadius="",this.link.style.borderBottomLeftRadius="",this.holder.style.marginRight=""),this.options.printModes.forEach(function(t){t.style.display=""}),this._form.style.display="none"},_printCancel:function(){this._map.off("mousedown",this._startPortraitPoligon,this),this._map.off("mousedown",this._startAutoPoligon,this),this._endPortrait(),this._endCustom(),this.options.portrait&&(this.options.portrait=void 0,this._map.off("resize",this._reset,this),this._map.off("viewreset",this._reset,this),this._map.off("move",this._reset,this),this._map.off("moveend",this._reset,this),this._map.fire("moveend"))},_printLandscape:function(){this._endCustom(),this._print("Landscape")},_printAuto:function(){this._endCustom(),this._print("Auto")},_printCustom:function(){this._endCustom(),this._map.on("mousedown",this._startAutoPoligon,this),this._map.on("mouseup",this._endAutoPoligon,this),$(".leaflet-container").css("cursor","crosshair")},_printPortrait:function(t){L.DomEvent.preventDefault(t),this._endCustom(),this.options.portrait&&(this.options.portrait=void 0,this._map.off("resize",this._reset,this),this._map.off("viewreset",this._reset,this),this._map.off("move",this._reset,this),this._map.off("moveend",this._reset,this),this._map.fire("moveend")),this._map.on("mousedown",this._startPortraitPoligon,this),this._map.on("mouseup",this._endPortraitPoligon,this)},_reset:function(){if(this.options.portrait){var t=this.options.portrait.rectangle.getBounds();this._print("Portrait",t)}},_addPrintClassToContainer:function(t,o){var i=t.getContainer();-1===i.className.indexOf(o)&&(i.className+=" "+o)},_removePrintClassFromContainer:function(t,o){var i=t.getContainer();i.className&&-1<i.className.indexOf(o)&&(i.className=i.className.replace(" "+o,""))},_startAutoPoligon:function(t){t.originalEvent.preventDefault(),this._map.dragging.disable(),this._map,this._map.off("mousedown",this._startAutoPoligon,this),this._map.off("viewreset",this._reset,this),this._map.off("resize",this._reset,this),this._map.off("move",this._reset,this),this._map.off("moveend",this._reset,this),this.options.custom={start:t.latlng},this._map.on("mousemove",this._moveAutoPoligon,this)},_moveAutoPoligon:function(t){this.options.custom&&(t.originalEvent.preventDefault(),this.options.custom.rectangle&&this._map.removeLayer(this.options.custom.rectangle),this.options.custom.rectangle=L.rectangle([this.options.custom.start,t.latlng],{color:"gray",dashArray:"5, 10"}),this.options.custom.rectangle.addTo(this._map))},_endAutoPoligon:function(t){if(t.originalEvent.preventDefault(),this._endCustom(),this._map.dragging.enable(),this.options.custom){this._map.removeLayer(this.options.custom.rectangle);var o=this.options.custom.rectangle.getBounds();this.options.custom=void 0,this._print("Custom",o)}},_startPortraitPoligon:function(t){t.originalEvent.preventDefault(),this._map.dragging.disable(),this._map.off("mousedown",this._startPortraitPoligon,this),this.options.portrait={start:t.latlng},this._map.on("mousemove",this._movePortraitPoligon,this)},_movePortraitPoligon:function(t){this.options.portrait&&(t.originalEvent.preventDefault(),this.options.portrait.rectangle&&this._map.removeLayer(this.options.portrait.rectangle),this.options.portrait.rectangle=L.rectangle([this.options.portrait.start,t.latlng],{color:"gray",dashArray:"5, 10"}),this.options.portrait.rectangle.addTo(this._map))},_endPortraitPoligon:function(t){if(t.originalEvent.preventDefault(),this._endPortrait(),this.options.portrait&&this._map.removeLayer(this.options.portrait.rectangle),this._map.dragging.enable(),this.options.portrait){var o=this.options.portrait.rectangle.getBounds();this._print("Portrait",o),this._map.on("resize",this._reset,this),this._map.on("viewreset",this._reset,this),this._map.on("move",this._reset,this),this._map.on("moveend",this._reset,this)}},_endPortrait:function(){this._map.off("mousemove",this._movePortraitPoligon,this),this._map.off("mouseup",this._endPortraitPoligon,this),$(".leaflet-container").css("cursor","")},_endCustom:function(){this._map.off("mousemove",this._moveAutoPoligon,this),this._map.off("mouseup",this._endAutoPoligon,this),$(".leaflet-container").css("cursor","")},_appendControlStyles:function(){var t=document.createElement("style");t.setAttribute("type","text/css"),t.innerHTML+=" .leaflet-control-browser-print a { background: #fff url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3gcCCi8Vjp+aNAAAAGhJREFUOMvFksENgDAMA68RC7BBN+Cf/ZU33QAmYAT6BolAGxB+RrrIsg1BpfNBVXcPMLMDI/ytpKozMHWwK7BJJ7yYWQbGdBea9wTIkRDzKy0MT7r2NiJACRgotCzxykFI34QY2Ea7KmtxGJ+uX4wfAAAAAElFTkSuQmCC') no-repeat 5px; background-size: 16px 16px; display: block; border-radius: 4px; }",t.innerHTML+=" .v0-7.leaflet-control-browser-print a#leaflet-browser-print { width: 30px; height: 30px; } .v1.leaflet-control-browser-print a#leaflet-browser-print { background-position-x: 7px; }",t.innerHTML+=" .browser-print-holder { margin: 0px; padding: 0px; list-style: none; white-space: nowrap; } .browser-print-holder-left li:last-child { border-top-right-radius: 2px; border-bottom-right-radius: 2px; } .browser-print-holder-right li:first-child { border-top-left-radius: 2px; border-bottom-left-radius: 2px; }",t.innerHTML+=" .browser-print-mode { display: none; background-color: #919187; color: #FFF; font: 11px/19px 'Helvetica Neue', Arial, Helvetica, sans-serif; text-decoration: none; padding: 4px 10px; text-align: center; } .v1 .browser-print-mode { padding: 6px 10px; } .browser-print-mode:hover { background-color: #757570; cursor: pointer; }",t.innerHTML+=" .leaflet-browser-print--custom, .leaflet-browser-print--custom path { cursor: crosshair!important; }",t.innerHTML+=" .leaflet-print-overlay { width: 100%; height: 100%; position: absolute; top: 0; background-color: white; left: 0; z-index: 1001; display: block!important; } ",t.innerHTML+=" .leaflet--printing { overflow: hidden!important; margin: 0px!important; padding: 0px!important; } body.leaflet--printing > * { display: none; }",document.getElementsByTagName("head")[0].appendChild(t)},_print:function(t,o){var i=this;if("Portrait"==t){if(o._southWest.lat<o._northEast.lat)var e=o._southWest.lat,n=o._northEast.lat;if(o._southWest.lng<o._northEast.lng)var s=o._southWest.lng,a=o._northEast.lng;var r=Number(this._input_lat.value),l=Number(this._input_lon.value);(""==r||isNaN(r))&&(r=0),(""==l||isNaN(l))&&(l=0),i.__draw_frame_stick(this.options.latlngControl,n,s,e,a,r,l,2,10,5,1,!0)}else{if(this.changeElStylForStart(t,o),this.options.portrait){var h=this.options.portrait.rectangle.getBounds(),p=o;if(p.contains(h)){i.__draw_outer_frame(this.options.latlngControl,p,h,5)}}i._map.isLoading||(i._map.isLoading=function(){return this._tilesToLoad||this._tileLayersToLoad}),window.NProgress&&NProgress.start();var d=setInterval(function(){if(!i._map.isLoading()){clearInterval(d),domtoimage.preUrl=i.options.preUrl;var t=i.options.eleid,o=document.getElementById(t);domtoimage.toPng(o).then(function(t){i.changeElStylForEnd(),window.NProgress&&NProgress.done(!0),toastr.success("导出完成");var o=i._dataURItoBlob(t);i._downloadFile("地图截图.png",o),i._clearRect()}).catch(function(t){i.changeElStylForEnd(),window.NProgress&&NProgress.done(!0),console.error("未知原因，导出失败!",t),toastr.success("导出失败")})}},50)}},changeElStylForStart:function(t,o){switch($(".leaflet-control").hide(),$(".leaflet-control-scale").show(),$(".no-print").hide(),$("html").css({overflow:"auto","background-color":"#888"}),$("body").css({overflow:"auto","background-color":"#888"}),this.$mapParentDiv.css({"background-color":"#ffffff",left:"0"}),t){default:case"Auto":break;case"Landscape":this.$mapParentDiv.css({width:"1040px",height:"715px"});break;case"Portrait":this.$mapParentDiv.css({width:"850px",height:"1100px"});break;case"Custom":var i=this._map.latLngToLayerPoint(o.getNorthWest()),e=this._map.latLngToLayerPoint(o.getSouthEast()),n=Math.abs(e.x-i.x),s=Math.abs(e.y-i.y);this.$mapParentDiv.css({width:n+"px",height:s+"px"}),this._map.invalidateSize(!1),this._map.fitBounds(o,{animate:!1})}this.invalidateSize()},changeElStylForEnd:function(){$(".leaflet-control").show(),$(".no-print").show(),$("html").css({overflow:"hidden","background-color":"#ffffff"}),$("body").css({overflow:"hidden","background-color":""}),this.$mapParentDiv.css({"background-color":"",border:"",position:"",top:"0",bottom:"0",left:"0",right:"0",height:"100%",width:"100%"}),this.invalidateSize()},invalidateSize:function(){this._map.invalidateSize(!1)},_dataURItoBlob:function(t){for(var o=atob(t.split(",")[1]),i=t.split(",")[0].split(":")[1].split(";")[0],e=new ArrayBuffer(o.length),n=new DataView(e),s=0;s<o.length;s++)n.setUint8(s,o.charCodeAt(s));return new Blob([e],{type:i})},_downloadFile:function(t,o){var i=document.createElement("a");i.download=t,i.href=URL.createObjectURL(o),document.body.appendChild(i),i.click(),document.body.removeChild(i)},_clearRect:function(){if(this._input_lon.value="",this._input_lat.value="",this.options.portrait=void 0,this.options.latlngControl._container){try{this._map.getPanes().overlayPane.removeChild(this.options.latlngControl._container)}catch(t){}this._isContainerRemove=!0,this._map.off("viewreset",this.options.latlngControl._reset,this.options.latlngControl),this._map.off("move",this.options.latlngControl._reset,this.options.latlngControl),this._map.off("moveend",this.options.latlngControl._reset,this.options.latlngControl),this._map.options.zoomAnimation&&this._map.off("zoomanim",this.options.latlngControl._animateZoom,this.options.latlngControl)}},__draw_outer_frame:function(t,o,i,e){if(o._southWest.lat<o._northEast.lat)var n=o._southWest.lat,s=o._northEast.lat;if(o._southWest.lng<o._northEast.lng)var a=o._southWest.lng,r=o._northEast.lng;var l=t._latLngToCanvasPoint(L.latLng(s,a)),h=(t._latLngToCanvasPoint(L.latLng(s,r)),t._latLngToCanvasPoint(L.latLng(n,a)),t._latLngToCanvasPoint(L.latLng(n,r)));if(i._southWest.lat<i._northEast.lat)var p=i._southWest.lat,d=i._northEast.lat;if(i._southWest.lng<i._northEast.lng)var _=i._southWest.lng,m=i._northEast.lng;var f=t._latLngToCanvasPoint(L.latLng(d,_)),c=(t._latLngToCanvasPoint(L.latLng(d,m)),t._latLngToCanvasPoint(L.latLng(p,_)),t._latLngToCanvasPoint(L.latLng(p,m))),g=t._canvas.getContext("2d");g.fillStyle="white",g.fillRect(l.x-1,l.y+1,h.x-l.x+2,h.y-l.y-2),g.clearRect(f.x-1,f.y+1,c.x-f.x+2,c.y-f.y-2);var u=Number(this._input_lat.value),v=Number(this._input_lon.value);(""==u||isNaN(u))&&(u=0),(""==v||isNaN(v))&&(v=0),this.__draw_frame_stick(this.options.latlngControl,d,_,p,m,u,v,2,10,5,1,!0)},__draw_frame_stick:function(t,o,i,e,n,s,a,r,l,h,p,d){var _=e,m=o,f=i,c=n;1==this._isContainerRemove&&(t._map||(t._map=this._map),t._container||t._initCanvas(),this._map._panes.overlayPane.appendChild(t._container),this._isContainerRemove=!1,map.on("viewreset",t._reset,t),map.on("move",t._reset,t),map.on("moveend",t._reset,t),map.options.zoomAnimation&&L.Browser.any3d&&map.on("zoomanim",t._animateZoom,t),t._reset());var g=t._latLngToCanvasPoint(L.latLng(m,f)),u=t._latLngToCanvasPoint(L.latLng(m,c)),v=t._latLngToCanvasPoint(L.latLng(_,f)),y=t._latLngToCanvasPoint(L.latLng(_,c)),b=t._canvas.getContext("2d");b.beginPath(),b.moveTo(g.x-1,g.y+1),b.lineTo(u.x+1,u.y-1),b.lineTo(y.x+1,y.y-1),b.lineTo(v.x-1,v.y+1),b.lineTo(g.x-1,g.y+1),b.closePath(),b.lineWidth=h,b.strokeStyle="black",b.stroke(),b.beginPath(),b.moveTo(g.x-7,g.y-7),b.lineTo(u.x+7,u.y-7),b.lineTo(y.x+7,y.y+7),b.lineTo(v.x-7,v.y+7),b.lineTo(g.x-7,g.y-7),b.closePath(),b.lineWidth=2,b.strokeStyle="black",b.stroke();for(var x=(o-e)/s,P=(n-i)/a,C=e;C<o;C+=x){var w=this.__format_lat_dfs(C),T=b.measureText(w).width,A=t._latLngToCanvasPoint(L.latLng(C,i)),k=t._latLngToCanvasPoint(L.latLng(C,n));d&&(b.beginPath(),b.lineWidth=p,b.moveTo(A.x,A.y),b.lineTo(k.x,k.y),b.strokeStyle="grey",b.stroke()),b.beginPath(),b.moveTo(A.x,A.y),b.lineTo(A.x-7-l,A.y),b.lineWidth=r,b.strokeStyle="black",b.stroke(),b.font="10px Verdana",b.save(),b.translate(A.x-l-5-15,A.y),b.rotate(-Math.PI/2),b.fillStyle="black",b.fillText(w,-T/2,0),b.restore()}w=this.__format_lat_dfs(o),T=b.measureText(w).width,A=t._latLngToCanvasPoint(L.latLng(o,i));b.beginPath(),b.moveTo(A.x,A.y),b.lineTo(A.x-7-l,A.y),b.lineWidth=r,b.strokeStyle="black",b.stroke(),b.font="10px Verdana",b.save(),b.translate(A.x-l-5-15,A.y),b.rotate(-Math.PI/2),b.fillStyle="black",b.fillText(w,-T/2,0),b.restore();for(C=i;C<n;C+=P){var E=this.__format_lon_dfs(C);T=b.measureText(E).width,A=t._latLngToCanvasPoint(L.latLng(e,C)),k=t._latLngToCanvasPoint(L.latLng(o,C));d&&(b.beginPath(),b.lineWidth=p,b.moveTo(A.x,A.y),b.lineTo(k.x,k.y),b.strokeStyle="grey",b.stroke()),b.beginPath(),b.moveTo(A.x,A.y),b.lineTo(A.x,A.y+7+l),b.lineWidth=r,b.strokeStyle="black",b.stroke(),b.font="10px Verdana",b.fillStyle="black",b.fillText(E,A.x-T/2+5,A.y+l+5+15)}E=this.__format_lon_dfs(n),T=b.measureText(E).width,A=t._latLngToCanvasPoint(L.latLng(e,n));b.beginPath(),b.moveTo(A.x,A.y),b.lineTo(A.x,A.y+7+l),b.lineWidth=r,b.strokeStyle="black",b.stroke(),b.font="10px Verdana",b.fillStyle="black",b.fillText(E,A.x-T/2+5,A.y+l+5+15)},__format_degree_dfs:function(t){var o=Math.floor(t);return o+"°"+Math.floor(60*(t-o))+"'"+Math.round(3600*(t-o)%60)+'"'},__format_lat_dfs:function(t){return t<0?this.__format_degree_dfs(-1*t)+"S":0<t?this.__format_degree_dfs(t)+"N":this.__format_degree_dfs(t)},__format_lon_dfs:function(t){return 180<t?this.__format_degree_dfs(360-t)+"W":0<t&&t<180?this.__format_degree_dfs(t)+"E":t<0&&-180<t?this.__format_degree_dfs(-1*t)+"W":-180==t?""+this.__format_degree_dfs(-1*t):t<-180?this.__format_degree_dfs(360+t)+"W":this.__format_degree_dfs(t)}});