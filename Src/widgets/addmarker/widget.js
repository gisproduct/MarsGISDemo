/* 2018-7-27 23:16:28 | 版权所有 火星科技 http://marsgis.cn  【联系我们QQ：516584683，微信：marsgis】 */
var addmarkerWidget=L.widget.bindClass(L.widget.BaseWidget.extend({map:null,options:{resources:["map.css"],view:{type:"window",url:"view.html",windowOptions:{width:300,height:400}}},layerGroup:null,layerDraw:null,layerDrawTip:null,markerControl:null,create:function(){this.layerGroup=L.featureGroup(),this.layerDraw=L.featureGroup().addTo(this.layerGroup),this.layerDrawTip=L.featureGroup().addTo(this.layerGroup),this.markerControl=new L.Draw.Marker(this.map,{icon:L.icon({iconUrl:this.path+"img/marker.png",iconSize:[40,40],iconAnchor:[15,37],popupAnchor:[5,-30]})}),bindToLayerControl("我的标记",this.layerGroup)},viewWindow:null,winCreateOK:function(e,a){this.viewWindow=a},activate:function(){this.map.addLayer(this.layerGroup),this.map.on("draw:created",this._map_draw_createdHndler,this),this.map.on("draw:editmove",this._map_draw_changeHandler,this),this.map.on("zoomend",this._map_zoomendHandler,this),this._map_zoomendHandler(),this.hasEdit(!0)},disable:function(){this.viewWindow=null,this.stopDraw(),this.hasEdit(!1),this.map.off("draw:created",this._map_draw_createdHndler,this),this.map.off("draw:editmove",this._map_draw_changeHandler,this),this.map.off("zoomend",this._map_zoomendHandler,this)},_map_zoomendHandler:function(e){var a=this.map.getZoom();this.editable&&14<a?this.layerGroup.addLayer(this.layerDrawTip):this.layerGroup.removeLayer(this.layerDrawTip)},stopDraw:function(){this.markerControl.disable()},drawPoint:function(){this.stopDraw(),this.markerControl.enable()},_marker_id:0,objResultFeature:{},_map_draw_createdHndler:function(e){var a=e.layer;this.bindMarkerEx(a),a.openPopup(),this.viewWindow.refMarkerList()},_map_draw_changeHandler:function(e){var a=e.layer;a._textMarker&&a._textMarker.setLatLng(a.getLatLng())},bindMarkerEx:function(e){var t=this;null==e.attr&&(e.attr={id:++this._marker_id,name:"",remark:""}),this.layerDraw.addLayer(e),this.objResultFeature[e.attr.id]=e,this.editable&&e.editing.enable(),e.bindPopup(function(e){var a=e.attr,r=a.id;return t.editable?'<div class="addmarker-popup-titile">添加标记</div><div class="addmarker-popup-content" ><form > <div class="form-group">  <label for="addmarker_attr_name">名称</label><input type="text" id="addmarker_attr_name" class="form-control" value="'+a.name+'" placeholder="请输入标记名称"    /> </div> <div class="form-group">  <label for="addmarker_attr_remark">备注</label><textarea id="addmarker_attr_remark" class="form-control" rows="4" style="resize: none;" placeholder="请输入备注（可选填）"   >'+a.remark+'</textarea></div><div class="form-group" style="text-align: center;"><input type="button" class="btn btn-primary  btn-sm" value="保存" onclick="addmarkerWidget.saveEditFeature('+r+')" />&nbsp;&nbsp;<input type="button" class="btn btn-danger  btn-sm" value="删除" onclick="addmarkerWidget.deleteEditFeature('+r+')" /></div></form></div>':'<div class="addmarker-popup-titile">我的标记</div><div class="addmarker-popup-content" ><form ><div class="form-group"><label>名称</label>：'+a.name+'</div> <div class="form-group"><label>备注</label>：'+a.remark+"</div></form></div>"},{maxWidth:400})},bindMarkerTip:function(e){if(this.editable){var a=e.attr.id;""==e.attr.name&&(e.attr.name="我的标记");var r='<i class="fa fa-pencil" onclick="addmarkerWidget.openEditFeature('+a+',event)"></i> <i class="fa fa-close"  onclick="addmarkerWidget.deleteEditFeature('+a+')"></i> ',t='<div><span class="name">'+e.attr.name+"</span>"+r+" </div><div>"+e.attr.remark+"</div>";e._textMarker?e._textMarker._icon?e._textMarker._icon.innerHTML=t:e._textMarker.setIcon(L.divIcon({className:"leaflet-addmarker-result",html:t,iconSize:[null,55],iconAnchor:[-30,55]})):e._textMarker=L.marker(e.getLatLng(),{icon:L.divIcon({className:"leaflet-addmarker-result",html:t,iconSize:[null,55],iconAnchor:[-30,55]})}).addTo(this.layerDrawTip)}},saveEditFeature:function(e){var a=this.objResultFeature[e];null!=a&&(a.attr.name=$.trim($("#addmarker_attr_name").val()),a.attr.remark=$.trim($("#addmarker_attr_remark").val()),this.bindMarkerTip(a),a.closePopup(),this.viewWindow.refMarkerList())},openEditFeature:function(e,a){var r=this.objResultFeature[e];null!=r&&(r.openPopup(),L.DomEvent.stopPropagation(a))},deleteEditFeature:function(e){var a=this.objResultFeature[e];null!=a&&(a.closePopup(),a._textMarker&&this.layerDrawTip.removeLayer(a._textMarker),this.layerDraw.removeLayer(a),this.objResultFeature[e]=null,this.viewWindow.refMarkerList())},getMarkerDataList:function(){for(var e=[],a=this.layerDraw.getLayers(),r=0;r<a.length;r++){var t=a[r];e.push(t.attr)}return e},centerAt:function(e){var a=this.objResultFeature[e];null!=a&&this.map.centerAtLayer(a)},deleteAll:function(){this.layerDraw.clearLayers(),this.layerDrawTip.clearLayers(),this.objResultFeature={},this._marker_id=0},getJsonData:function(){for(var e=[],a=this.layerDraw.getLayers(),r=0;r<a.length;r++){var t=a[r],i=t.getLatLng();t.attr.lat=Number(i.lat.toFixed(6)),t.attr.lng=Number(i.lng.toFixed(6)),e.push(t.attr)}return 0==a.length?null:JSON.stringify(e)},jsonToLayer:function(e,a){var r=JSON.parse(e);if(null!=r&&0!=r.length){a&&this.deleteAll();for(var t=0;t<r.length;t++){var i=r[t],n=L.marker([i.lat,i.lng],this.markerControl.options);(n.attr=i).id>this._marker_id&&(this._marker_id=i.id),this.bindMarkerEx(n),this.bindMarkerTip(n)}this.map.fitBounds(this.layerDraw.getBounds()),this.viewWindow.refMarkerList()}},editable:!0,hasEdit:function(e){this.editable=e,this._map_zoomendHandler();for(var a=this.layerDraw.getLayers(),r=0;r<a.length;r++){var t=a[r];t.closePopup(),this.editable?t.editing.enable():t.editing.disable(),this.bindMarkerTip(t)}}}));