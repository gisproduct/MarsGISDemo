/* 2018-7-29 17:46:54 | 版权所有 火星科技 http://marsgis.cn  【联系我们QQ：516584683，微信：marsgis】 */
L.widget.bindClass(L.widget.BaseWidget.extend({map:null,options:{},serverUrl:{key:["c95467d0ed2a3755836e37dc27369f97","4320dda936d909d73ab438b4e29cf2a2","e64a96ed7e361cbdc0ebaeaf3818c564","df3247b7df64434adecb876da94755d7","d4375ec477cb0a473c448fb1f83be781","13fdd7b2b90a9d326ae96867ebcc34ce","c34502450ae556f42b21760faf6695a0","57f8ebe12797a73fc5b87f5d4ef859b1"],route_bus_url:"http://restapi.amap.com/v3/direction/transit/integrated",route_car_url:"http://restapi.amap.com/v3/direction/driving"},layerWork:null,iconDot:null,create:function(){this.layerWork=L.featureGroup(),this.iconDot=L.divIcon({className:"",html:'<div style="background: #ffffff;border-radius: 50%;border: #3388ff 2px solid;width:100%;height:100%;"></div>',iconSize:[8,8]})},winCreateOK:function(t,a){},_key_index:0,getKey:function(){var t=this._key_index++%this.serverUrl.key.length;return this.serverUrl.key[t]},startMarker:null,endMarker:null,activate:function(){var a=this;this.map.addLayer(this.layerWork),this.map.contextmenu.insertItem("-",0),this.map.contextmenu.insertItem({id:"route-end",text:"清除路线规划",iconCls:"fa fa-trash-o",callback:function(t){a.clear()}},0),this.map.contextmenu.insertItem({id:"route-end",text:"设为终点",iconCls:"fa fa-flag-checkered",callback:function(t){a.addEndPoint(t.latlng),a.query()}},0),this.map.contextmenu.insertItem({id:"route-start",text:"设为起点",iconCls:"fa fa-flag-o",callback:function(t){a.addStartPoint(t.latlng),a.query()}},0)},disable:function(){this.map.removeLayer(this.layerWork),this.map.contextmenu.removeItem(0),this.map.contextmenu.removeItem(0),this.map.contextmenu.removeItem(0),this.map.contextmenu.removeItem(0)},clear:function(){this.startMarker=null,this.endMarker=null,this.layerWork.clearLayers()},addStartPoint:function(t){null!=t&&(this.startMarker=L.marker(t,{draggable:!0,icon:L.icon({iconUrl:this.path+"/img/start.png",iconSize:[30,42],iconAnchor:[15,32],popupAnchor:[0,-24],tooltipAnchor:[0,-24]})}).bindTooltip("<b>起点</b>",{className:"jsondatalayer-tooltip",direction:"top"}).addTo(this.layerWork),this.startMarker.on("moveend",this.query,this))},addEndPoint:function(t){null!=t&&(this.endMarker=L.marker(t,{draggable:!0,icon:L.icon({iconUrl:this.path+"img/end.png",iconSize:[30,42],iconAnchor:[15,32],popupAnchor:[0,-24],tooltipAnchor:[0,-24]})}).bindTooltip("<b>终点</b>",{className:"jsondatalayer-tooltip",direction:"top"}).addTo(this.layerWork),this.endMarker.on("moveend",this.query,this))},query:function(){if(null!=this.startMarker&&null!=this.endMarker){this.layerWork.clearLayers(),this.layerWork.addLayer(this.startMarker),this.layerWork.addLayer(this.endMarker);var startLatlng=this.startMarker.getLatLng(),endLatlng=this.endMarker.getLatLng(),startLatlng_wgs=this.map.convert2wgs(startLatlng),endLatlng_wgs=this.map.convert2wgs(endLatlng);startLatlng=L.mars.pointconvert.wgs2gcj([startLatlng_wgs[1],startLatlng_wgs[0]]),endLatlng=L.mars.pointconvert.wgs2gcj([endLatlng_wgs[1],endLatlng_wgs[0]]);var str_start_jwd=startLatlng[0]+","+startLatlng[1],str_end_jwd=endLatlng[0]+","+endLatlng[1],key=this.getKey();haoutil.loading.show("正在分析路线......");var that=this;$.ajax({url:this.serverUrl.route_car_url,type:"GET",dataType:"jsonp",timeout:"5000",contentType:"application/json;utf-8",data:{output:"json",extensions:"all",key:key,origin:str_start_jwd,destination:str_end_jwd},success:function(json){if(haoutil.loading.hide(),that.isActivate){var data=eval(json);if(0!=data.status)if(0!=data.route.paths.length){var paths0=data.route.paths[0],info={};info.strategy=paths0.strategy,info.taxi_cost=Number(data.route.taxi_cost).toFixed(0)+"元",info.duration=haoutil.str.formatTime(paths0.duration),info.distance=haoutil.str.formatLength(paths0.distance),info.traffic_lights=paths0.traffic_lights,0<paths0.tolls&&(info.tolls=Number(paths0.tolls).toFixed(0)+"元",info.toll_distance=haoutil.str.formatLength(paths0.toll_distance)),that.addRouteCar(paths0.steps,info)}else toastr.success("未查询到驾车路线！");else toastr.error("请求失败("+data.infocode+")："+data.info)}},error:function(t){haoutil.loading.hide(),toastr.error("请求出错("+t.status+")："+t.statusText)}})}},objStepLine:{},addRouteCar:function(t,a){var s=this;s.objStepLine={};for(var e=[],r="",n=this.startMarker.getLatLng(),i=0;i<t.length;i++){var o=t[i];o.road&&-1==e.indexOf(o.road)&&e.push(o.road);var l=[],d=o.polyline.split(";");if($.each(d,function(t,a){var e=a.split(",");if(2==e.length){var r=Number(e[0]),n=Number(e[1]),i=L.mars.pointconvert.gcj2wgs([r,n]),o=s.map.convert2map([i[1],i[0]]);l.push(o)}}),0!=l.length){var c=L.marker(l[l.length-1],{icon:this.iconDot});s.layerWork.addLayer(c),l.insert(n,0),i==t.length-1&&l.push(this.endMarker.getLatLng()),n=l[l.length-1];var h=L.polyline(l,{color:"#3388ff",weight:5,opacity:.8}).addTo(s.layerWork),u=i+1+". "+o.instruction;h.bindTooltip(u,{className:"jsondatalayer-tooltip",direction:"top"}),s.objStepLine[i]=h,r+="<br/>&nbsp;&nbsp;&nbsp;&nbsp;"+u}}var p="<div style='font-size:14px;' >"+a.distance+" | 驾车约"+a.duration+" | 红绿灯"+a.traffic_lights+"个 | 打车约"+a.taxi_cost;for(var i in a.tolls&&(p+="<br/>道路收费"+a.tolls+" | "+a.toll_distance),p+="<br/>途径："+e.join("&gt;"),p+="<br/>步骤："+r+"</div>",s.objStepLine){(h=s.objStepLine[i]).bindPopup(p,{maxWidth:450})}map.fitBounds(s.layerWork.getBounds())}}));