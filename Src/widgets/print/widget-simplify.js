/* 2018-9-21 19:22:13 | 版权所有 火星科技 http://marsgis.cn  【联系我们QQ：516584683，微信：marsgis】 */
var toolPrint=L.widget.bindClass(L.widget.BaseWidget.extend({map:null,options:{resources:["view.css","lib/print.js","lib/dom-to-image.js"],view:[{type:"append",url:"view.html"}]},$mapParentDiv:null,$mapDiv:null,create:function(){this.$mapParentDiv=$("#centerDiv"),this.$mapDiv=$("#"+this.map._container.id)},winCreateOK:function(t,i){var n=this;$("#view_print_type").hide(),$("#btn_print_expimg").click(function(){n.expImg()}),$("#btn_print_start").click(function(){n.printview()}),$("#btn_print_close").click(function(){n.disableBase()})},activate:function(){$(".leaflet-control").hide(),$(".leaflet-control-scale").show(),$(".no-print-view").hide(),this.invalidateSize()},disable:function(){$(".leaflet-control").show(),$(".no-print-view").show(),this.invalidateSize()},invalidateSize:function(){var t=this.map;setTimeout(function(){t.invalidateSize(!1)},200)},printview:function(){var t=this;this.changeElStylForStart(),this.$mapParentDiv.css({border:""}).print({noPrintSelector:".no-print",deferred:$.Deferred().done(function(){t.changeElStylForEnd()})})},expImg:function(){var n=this;this.changeElStylForStart(),domtoimage.proxy=function(t){return"/proxy/proxy.jsp?"+t},haoutil.loading.show();var t=document.getElementById("centerDiv");domtoimage.toPng(t).then(function(t){haoutil.loading.hide(),n.changeElStylForEnd();var i=n._dataURItoBlob(t);haoutil.file.download("地图截图.png",i),toastr.success("导出完成")}).catch(function(t){haoutil.loading.hide(),n.changeElStylForEnd(),console.error("未知原因，导出失败!",t),toastr.error("导出失败")})},_dataURItoBlob:function(t){for(var i=atob(t.split(",")[1]),n=t.split(",")[0].split(":")[1].split(";")[0],e=new ArrayBuffer(i.length),o=new DataView(e),a=0;a<i.length;a++)o.setUint8(a,i.charCodeAt(a));return new Blob([e],{type:n})},changeElStylForStart:function(){$(".no-print").hide()},changeElStylForEnd:function(){$(".no-print").show()}}));