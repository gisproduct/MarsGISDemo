/* 2018-9-21 19:22:13 | 版权所有 火星科技 http://marsgis.cn  【联系我们QQ：516584683，微信：marsgis】 */
var toolPrint=L.widget.bindClass(L.widget.BaseWidget.extend({map:null,options:{resources:["view.css","lib/print.js","lib/dom-to-image.js"],view:[{type:"append",url:"view.html"},{type:"append",url:"viewmap.html",parent:"#centerDiv"}]},$mapParentDiv:null,$mapDiv:null,create:function(){this.$mapParentDiv=$("#centerDiv"),this.$mapDiv=$("#"+this.map._container.id)},winCreateOK:function(t,i){var e=this;-1!=t.url.indexOf("view.html")?($("#btn_print_expimg").click(function(){e.expImg()}),$("#btn_print_start").click(function(){e.printview()}),$("#btn_print_type").change(function(){var t=$(this).val();e.changeSize(t)}),$("#btn_print_close").click(function(){e.disableBase()})):($("#btn_print_edititle").click(function(){e.editTitle()}),$("#btn_print_eidttitle_yes").click(function(){e.saveEidtTitle()}),$("#btn_print_eidttitle_no").click(function(){e.cancelEidtTitle()}))},activate:function(){$(".leaflet-control").hide(),$(".leaflet-control-scale").show(),$(".no-print-view").hide(),$("#mapprint_title_view").show(),$("#mapprint_title_editview").hide(),$("#mapprint_foot_view").show(),$("html").css({overflow:"auto","background-color":"#888"}),$("body").css({overflow:"auto","background-color":"#888"}),this.$mapParentDiv.css({position:"absolute","background-color":"#ffffff",left:"0",right:"0"}),this.$mapDiv.removeClass("map").addClass("map_print").css({position:"absolute"}),this.changeSize(this._lasttype),this.invalidateSize()},disable:function(){$(".leaflet-control").show(),$(".no-print-view").show(),$("#mapprint_title_view").hide(),$("#mapprint_title_editview").hide(),$("#mapprint_foot_view").hide(),$("html").css({overflow:"hidden","background-color":"#ffffff"}),$("body").css({overflow:"hidden","background-color":""}),this.$mapParentDiv.css({"background-color":"",border:"",position:"",top:"0",bottom:"0",left:"0",right:"0",height:"100%",width:"100%"}),this.$mapDiv.removeClass("map_print").addClass("map").css({position:""}),this.invalidateSize()},invalidateSize:function(){var t=this.map;setTimeout(function(){t.invalidateSize(!1)},200)},_lasttype:"A4H",changeSize:function(t){var i,e,n;switch(this._lasttype=t){default:case"A4H":i=297,e=210;break;case"A4Z":i=210,e=297,n=!0;break;case"A3H":i=420,e=297;break;case"A3Z":i=297,e=420,n=!0}n?(i-=10,e-=10):(i-=10,e-=15),this.$mapParentDiv.css({width:i+"mm",height:e+"mm"}),this.invalidateSize()},editTitle:function(){$("#mapprint_title_view").hide(),$("#mapprint_title_editview").show();var t=$("#lbl_printmap_title").html();$("#txt_printmap_title").val(t)},saveEidtTitle:function(){var t=$("#txt_printmap_title").val();$("#lbl_printmap_title").html(t),$("#mapprint_title_editview").hide(),$("#mapprint_title_view").show()},cancelEidtTitle:function(){$("#mapprint_title_editview").hide(),$("#mapprint_title_view").show()},printview:function(){var t=this;this.changeElStylForStart(),this.$mapParentDiv.css({border:""}).print({noPrintSelector:".no-print",deferred:$.Deferred().done(function(){t.changeElStylForEnd()})})},expImg:function(){var e=this;this.changeElStylForStart(),domtoimage.proxy=function(t){return"/proxy/proxy.jsp?"+t},haoutil.loading.show();var t=document.getElementById("centerDiv");domtoimage.toPng(t).then(function(t){haoutil.loading.hide(),e.changeElStylForEnd();var i=e._dataURItoBlob(t);haoutil.file.download("地图截图.png",i),toastr.success("导出完成")}).catch(function(t){haoutil.loading.hide(),e.changeElStylForEnd(),console.error("未知原因，导出失败!",t),toastr.error("导出失败")})},_dataURItoBlob:function(t){for(var i=atob(t.split(",")[1]),e=t.split(",")[0].split(":")[1].split(";")[0],n=new ArrayBuffer(i.length),a=new DataView(n),o=0;o<i.length;o++)a.setUint8(o,i.charCodeAt(o));return new Blob([n],{type:e})},changeElStylForStart:function(){$(".no-print").hide()},changeElStylForEnd:function(){$(".no-print").show()}}));