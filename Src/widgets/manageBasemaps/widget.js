/* 2018-11-7 10:13:37 | 版权所有 火星科技 http://marsgis.cn  【联系我们QQ：516584683，微信：marsgis】 */
L.widget.bindClass(L.widget.BaseWidget.extend({map:null,options:{view:{type:"window",url:"view.html",windowOptions:{width:190,height:160}}},create:function(){for(var e=0,i=this.getBasemaps(),t=0;t<i.length;t++){var a=i[t];null!=a.name&&""!=a.name&&null!=a._layer&&e++}this.options.view.windowOptions=e<7?{width:190,height:100*Math.ceil(e/2)+60}:{width:360,height:105*Math.ceil(e/4)+60},L.Map.prototype.setCrs=function(e){this.options.crs=e}},viewWindow:null,winCreateOK:function(e,i){this.viewWindow=i},activate:function(){},disable:function(){this.viewWindow=null},getBasemaps:function(){return this.map.gisdata.config.basemaps},getLayerVisible:function(e){return this.map.hasLayer(e)},updateLayerVisible:function(e,i){if(i){if(null!=e.config.crs&&this.map.gisdata.config.crs!=e.config.crs){var t=this.map.convert2wgs(this.map.getCenter()),a=this.map.getZoom(),n=window.location.href;-1!=n.lastIndexOf("#")&&(n=n.replace(window.location.hash,"").replace("#",""));var r=n.lastIndexOf("?");-1!=r&&(n=n.substring(0,r)),this.map.remove();var s=n+"?center="+(t[0]+","+t[1]+","+a)+"&baselayer="+e.config.name,o=haoutil.system.getRequest();for(var l in o)"center"!=l&&"baselayer"!=l&&(s+="&"+l+"="+o[l]);return void(window.location.href=s)}this.map.addLayer(e),e.config&&e.config.order&&this.udpateLayerZIndex(e,e.config.order),this.map.fire("baselayerchange",{layer:e})}else this.map.removeLayer(e)},udpateLayerZIndex:function(e,i){var n;if(e.setZIndex)e.setZIndex(i);else if(e.bringToFront&&this._layers){this._layers.sort((n="order",function(e,i){var t=e[n],a=i[n];return t<a?-1:a<t?1:0}));for(var t=0;t<this._layers.length;t++){var a=this._layers[t];a._layer&&map.hasLayer(a._layer)&&a._layer.bringToFront&&(a._layer.bringToFront(),a._layer.redraw&&a._layer.redraw())}}}}));