/* 2018-11-24 18:04:47 | 版权所有 火星科技 http://marsgis.cn  【联系我们QQ：516584683，微信：marsgis】 */
var widget_queryBaiduPOI=L.widget.bindClass(L.widget.BaseWidget.extend({map:null,options:{resources:["view.css"],view:{type:"append",url:"view.html",parent:"#centerDiv"}},configBaidu:{key:["5BdfbH8G0acGrG8bvauqkc6RClTe64fz"],url:"http://api.map.baidu.com/place/v2/search",region:"全国"},create:function(){var i=this;$.getJSON(this.path+"config.json",function(t){i.configBaidu=t})},winCreateOK:function(t,i){if("append"==t.type){var e=this;$("#map-querybar").css(e.config.style||e.config.position||{left:"15px",top:"15px"}),$("#map-querybar img").each(function(t,i){$(i).attr("src",e.path+$(i).attr("src"))}),$("#txt_querypoi").focus(function(){0==$.trim($(this).val()).length&&(e.hideAllQueryBarView(),e.showHistoryList())}),$("#txt_querypoi").bind("input propertychange",function(){e.hideAllQueryBarView(),e.clearLayers();var t=$.trim($("#txt_querypoi").val());0==t.length?e.showHistoryList():e.autoTipList(t,!0)}),$("#btn_querypoi").click(function(){e.hideAllQueryBarView();var t=$.trim($("#txt_querypoi").val());e.strartQueryPOI(t,!0)}),$("#txt_querypoi").bind("keydown",function(t){"13"==t.keyCode&&$("#btn_querypoi").click()}),$("#querybar_detail_back").click(function(){e.hideAllQueryBarView(),$("#querybar_resultlist_view").show()})}},activate:function(){this.map.on("click",this.map_clickHandler,this)},disable:function(){this.map.off("click",this.map_clickHandler,this)},map_clickHandler:function(){0==$.trim($("#txt_querypoi").val()).length&&this.hideAllQueryBarView()},hideAllQueryBarView:function(){$("#querybar_histroy_view").hide(),$("#querybar_autotip_view").hide(),$("#querybar_detail_view").hide(),$("#querybar_resultlist_view").hide()},autoSearch:function(t){$("#txt_querypoi").val(t),$("#btn_querypoi").trigger("click")},_key_index:0,getKey:function(){var t=this._key_index++%this.configBaidu.key.length;return this.configBaidu.key[t]},autoTipList:function(t,i){if(this.hasExWidget()&&i)this.autoExTipList(t);else{var e=this.getKey();$.ajax({url:this.configBaidu.url,type:"GET",dataType:"jsonp",timeout:"5000",contentType:"application/json;utf-8",data:{output:"json",ak:e,scope:1,page_size:10,page_num:0,query:t,city_limit:!0,region:this.config.region||this.configBaidu.region},success:function(t){if(0===t.status){for(var i=t.results,e="",a=0;a<i.length;a++){var r=i[a].name;0<i[a].num||(e+="<li><a href=\"javascript:widget_queryBaiduPOI.autoSearch('"+r+"');\">"+r+"</a></li>")}0<e.length&&($("#querybar_ul_autotip").html(e),$("#querybar_autotip_view").show())}else toastr.error("请求失败("+t.status+")："+t.message)},error:function(t){toastr.error("请求出错("+t.status+")："+t.statusText)}})}},queryText:null,queryRegion:null,strartQueryPOI:function(t,i){if(0!=t.length)if(this.addHistory(t),this.hideAllQueryBarView(),this.hasExWidget()&&i)this.queryExPOI(t);else this.thispage=1,this.queryText=t,this.queryRegion=this.config.region||this.configBaidu.region,this.queryPOI();else toastr.warning("请输入搜索关键字！")},queryPOIForCity:function(t){this.thispage=1,this.queryRegion=t,this.queryPOI()},queryPOI:function(){var e=this,t=this.getKey();$.ajax({url:this.configBaidu.url,type:"GET",dataType:"jsonp",timeout:"5000",contentType:"application/json;utf-8",data:{output:"json",ak:t,scope:2,page_size:this.pageSize,page_num:this.thispage-1,query:this.queryText,region:this.queryRegion},success:function(t){if(e.isActivate)if(0===t.status){var i=t.results;i&&0<i.length&&0<i[0].num?e.workShowCitys.showResult(i):e.showPOIPage(i,t.total)}else toastr.error("请求失败("+t.status+")："+t.message)},error:function(t){toastr.error("请求出错("+t.status+")："+t.statusText)}})},workShowCitys:{pageSize:10,arrdata:[],counts:0,allpage:0,thispage:0,showResult:function(t){this.arrdata=t,this.counts=t.length,this.allpage=Math.ceil(this.counts/this.pageSize),this.thispage=1,this.showPOIPage()},showPOIPage:function(){var t="",i=(this.thispage-1)*this.pageSize,e=i+this.pageSize;e>=this.counts&&(e=this.counts);for(var a=i;a<e;a++){var r=this.arrdata[a];r.index=a+1;var s=r.name;t+='<div class="querybar-site" onclick="widget_queryBaiduPOI.queryPOIForCity(\''+s+'\')"> <div class="querybar-sitejj"> <div style=" float: left;">'+s+'</div> <div style=" float: right;  ">约'+r.num+"个结果</div></div> </div>"}t+='<div class="querybar-page"><div class="querybar-fl">找到<strong>'+this.counts+'</strong>个结果</div><div class="querybar-ye querybar-fr">'+this.thispage+"/"+this.allpage+'页  <a href="javascript:widget_queryBaiduPOI.workShowCitys.showFirstPage()">首页</a> <a href="javascript:widget_queryBaiduPOI.workShowCitys.showPretPage()">&lt;</a>  <a href="javascript:widget_queryBaiduPOI.workShowCitys.showNextPage()">&gt;</a> </div></div>',$("#querybar_resultlist_view").html(t),$("#querybar_resultlist_view").show()},showFirstPage:function(){this.thispage=1,this.showPOIPage()},showNextPage:function(){this.thispage=this.thispage+1,this.thispage>this.allpage&&(this.thispage=this.allpage),this.showPOIPage()},showPretPage:function(){this.thispage=this.thispage-1,this.thispage<1&&(this.thispage=1),this.showPOIPage()}},pageSize:6,arrdata:[],counts:0,allpage:0,thispage:0,showPOIPage:function(t,i){this.arrdata=t,this.counts=i,this.counts<t.length&&(this.counts=t.length),this.allpage=Math.ceil(this.counts/this.pageSize);var e="";if(0==this.counts)e+='<div class="querybar-page"><div class="querybar-fl">没有找到"<strong>'+this.queryText+'</strong>"相关结果</div></div>';else{for(var a=0;a<this.arrdata.length;a++){var r=this.arrdata[a],s=(this.thispage-1)*this.pageSize;r.index=s+(a+1);var o=a,h=r.name;e+='<div class="querybar-site" onclick="widget_queryBaiduPOI.showDetail(\''+o+'\')"> <div class="querybar-sitejj"> <h3>'+r.index+"、"+h+"</h3> <p>"+(r.address||"")+"</p> </div> </div>",this.objResultData[o]=r}var n;n=1<this.allpage?'<div class="querybar-ye querybar-fr">'+this.thispage+"/"+this.allpage+'页  <a href="javascript:widget_queryBaiduPOI.showFirstPage()">首页</a> <a href="javascript:widget_queryBaiduPOI.showPretPage()">&lt;</a>  <a href="javascript:widget_queryBaiduPOI.showNextPage()">&gt;</a> </div>':"",e+='<div class="querybar-page"><div class="querybar-fl">找到<strong>'+this.counts+"</strong>条结果</div>"+n+"</div>"}$("#querybar_resultlist_view").html(e),$("#querybar_resultlist_view").show(),this.showPOIArr(this.arrdata),1==this.counts&&this.showDetail("0")},showFirstPage:function(){this.thispage=1,this.queryPOI()},showNextPage:function(){if(this.thispage=this.thispage+1,this.thispage>this.allpage)return this.thispage=this.allpage,void toastr.warning("当前已是最后一页了");this.queryPOI()},showPretPage:function(){if(this.thispage=this.thispage-1,this.thispage<1)return this.thispage=1,void toastr.warning("当前已是第一页了");this.queryPOI()},objResultData:{},showDetail:function(t){$("#querybar_resultlist_view").hide(),$("#querybar_detail_view").show();var i=this.objResultData[t],e=i.name;12<e.length&&(e=e.substring(0,11)+".."),$("#lbl_poi_name").html(e);var a="<p>名称："+i.name+"</p>";i.telephone&&(a+="<p>电话："+i.telephone+"</p>"),i.address&&(a+="<p>地址："+i.address+"</p>"),i.detail_info&&i.detail_info.tag&&(a+="<p>类别："+i.detail_info.tag+"</p>"),$("#poi_detail_info").html(a),i.detail_info&&i.detail_info.detail_url?($("#btnShowDetail").show(),$("#btnShowDetail").attr("href",i.detail_info.detail_url)):$("#btnShowDetail").hide(),i.layer?this.centerAt(i.layer):toastr.warning('"'+e+'"无地理坐标信息！')},layerWork:null,getWorkLayer:function(){return null==this.layerWork&&(this.layerWork=L.markerClusterGroup({chunkedLoading:!0,spiderfyOnMaxZoom:!0,disableClusteringAtZoom:17}).addTo(this.map)),this.layerWork},clearLayers:function(){null!=this.layerWork&&this.layerWork.clearLayers()},showPOIArr:function(t){var c=this,g=this.getWorkLayer();g.clearLayers(),$.each(t,function(t,i){var e=i.location.lng,a=i.location.lat;if(0<e&&0<a){var r,s=L.mars.pointconvert.bd2wgs([e,a]);e=s[0],a=s[1],r=c.map.convert2map([a,e]);var o=L.marker(r,{icon:L.icon({iconUrl:c.path+"images/poi.png",iconSize:[16,16],iconAnchor:[8,8],popupAnchor:[0,-8]})}),h='<div class="mars-popup-titile">'+((o.attributes=i).detail_info&&i.detail_info.detail_url?'<a href="'+i.detail_info.detail_url+'"  target="_black" style="color: #ffffff; ">'+i.name+"</a>":i.name)+'</div><div class="mars-popup-content" >',n=$.trim(i.telephone);""!=n&&(h+="<div><label>电话</label>"+n+"</div>");var l=$.trim(i.address);if(""!=l&&(h+="<div><label>地址</label>"+l+"</div>"),i.detail_info){var u=$.trim(i.detail_info.tag);""!=u&&(h+="<div><label>类别</label>"+u+"</div>")}h+="</div>",o.bindPopup(h),g.addLayer(o),i.layer=o}}),0<g.getLayers().length&&this.map.fitBounds(g.getBounds())},centerAt:function(t){var i=t.getLatLng();this.map.centerAt(i),t.openPopup()},cookieName:"querypoi_gis",arrHistory:[],showHistoryList:function(){$("#querybar_histroy_view").hide();var lastcookie=haoutil.cookie.get(this.cookieName);if(null!=lastcookie&&(this.arrHistory=eval(lastcookie),null!=this.arrHistory&&0!=this.arrHistory.length)){for(var inhtml="",index=this.arrHistory.length-1;0<=index;index--){var item=this.arrHistory[index];inhtml+="<li><a href=\"javascript:widget_queryBaiduPOI.autoSearch('"+item+"');\">"+item+"</a></li>"}$("#querybar_ul_history").html(inhtml),$("#querybar_histroy_view").show()}},clearHistory:function(){this.arrHistory=[],haoutil.cookie.del(this.cookieName),$("#querybar_ul_history").html(""),$("#querybar_histroy_view").hide()},addHistory:function(data){this.arrHistory=[];var lastcookie=haoutil.cookie.get(this.cookieName);null!=lastcookie&&(this.arrHistory=eval(lastcookie)),this.arrHistory.remove(data),this.arrHistory.push(data),10<this.arrHistory.length&&this.arrHistory.splice(0,1),lastcookie=JSON.stringify(this.arrHistory),haoutil.cookie.add(this.cookieName,lastcookie)},exWidget:null,hasExWidget:function(){return!1},autoExTipList:function(t){var i=this;this.exWidget.autoTipList(t,function(){i.autoTipList(t,!1)})},queryExPOI:function(t){var i=this.getWorkLayer(),e=this;this.exWidget.strartQueryPOI(t,i,function(){e.strartQueryPOI(t,!1)})}}));